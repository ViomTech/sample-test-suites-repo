<!DOCTYPE html>
<html>
<head>
    <title>Test Performance Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.1.1/dist/chartjs-chart-matrix.min.js"></script>
    <style>
        .card { margin-bottom: 20px; }
        .table { margin-bottom: 0; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Test Performance Dashboard</h1>
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Step Duration Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="stepDurationChart" height="200"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Feature-wise Performance</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="featurePerformanceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Slowest Steps</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Feature</th>
                                        <th>Scenario</th>
                                        <th>Step</th>
                                        <th>Duration (ms)</th>
                                    </tr>
                                </thead>
                                <tbody id="slowestStepsTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Platform Comparison</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="platformComparisonChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Scenario Timeline</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Flagged Steps (Consistently Slow)</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Step</th>
                                        <th>Occurrences</th>
                                        <th>Avg Duration (ms)</th>
                                    </tr>
                                </thead>
                                <tbody id="flaggedStepsTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Step Duration Trends for Slow Steps (Current Run)</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="stepTrendsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Step Duration Distribution Chart
        new Chart(document.getElementById('stepDurationChart'), {
            type: 'bar',
            data: {
                labels: ["[App Launch]","check that API response \"userP...","check that response \"profileRe...","with the below JSON request","compose a get request to \"http...","check that response \"repoCheck...","compose a post request to \"htt...","check that response \"createRep...","compose a delete request to \"h...","check that API response \"creat...","check that API response \"repoC...","check that response \"deleteRes...","check that API response \"profi...","check that response \"userProfi...","execute and save the response ..."],
                datasets: [{
                    label: 'Average Duration (ms)',
                    data: [4.0,0.0,0.0,35.0,1.6666666666666667,0.0,1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,1.2],
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                // Use the full label from the mapping
                                const label = context[0].label;
                                return stepLabelMap[label] || label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 30,
                            autoSkip: false
                        }
                    },
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Feature Performance Chart
        new Chart(document.getElementById('featurePerformanceChart'), {
            type: 'pie',
            data: {
                labels: ["execute and save the response as \"deleteResponse\"","[App Launch]","execute and save the response as \"repoCheckResponse\"","check that response \"createRepoResponse\" has \"201\" as status code","check that response \"userProfile\" has \"200\" as status code","check that response \"profileResponse\" has \"200\" as status code","with the below JSON request","check that API response \"createRepoResponse\" contains \"demo-repo\" at \"$.name\"","compose a get request to \"https://api.github.com/user\" with headers","compose a post request to \"https://api.github.com/user/repos\" with headers","compose a get request to \"https://api.github.com/users/octocat\" with headers","check that response \"repoCheckResponse\" has \"200\" as status code","execute and save the response as \"createRepoResponse\"","execute and save the response as \"userProfile\"","check that response \"deleteResponse\" has \"204\" as status code","compose a delete request to \"https://api.github.com/repos/guptaami-commits/demo-repo\" with headers","check that API response \"repoCheckResponse\" contains \"demo-repo\" at \"$.name\"","check that API response \"userProfile\" contains \"80874758\" at \"$.id\"","execute and save the response as \"profileResponse\"","compose a get request to \"https://api.github.com/repos/guptaami-commits/demo-repo\" with headers","check that API response \"profileResponse\" contains \"The Octocat\" at \"$.name\"","check that API response \"profileResponse\" contains \"octocat\" at \"$.login\""],
                datasets: [{
                    data: [1.0,4.0,1.0,0.0,0.0,0.0,35.0,0.0,0.0,1.0,4.0,0.0,1.0,1.0,0.0,0.0,1.0,0.0,2.0,1.0,0.0,0.0],
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.5)',
                        'rgba(54, 162, 235, 0.5)',
                        'rgba(255, 206, 86, 0.5)',
                        'rgba(75, 192, 192, 0.5)',
                        'rgba(153, 102, 255, 0.5)'
                    ]
                }]
            },
            options: {
                responsive: true
            }
        });

        // Populate Slowest Steps Table
        const slowestSteps = [{"feature":"APITests.feature","scenario":"Create a public repo","step":"with the below JSON request","duration":35},{"feature":"[App Luanch]","scenario":"[App Launch]","step":"[App Launch]","duration":4},{"feature":"APITests.feature","scenario":"Fetch my GitHub public profile","step":"compose a get request to \"https://api.github.com/users/octocat\" with headers","duration":4},{"feature":"APITests.feature","scenario":"Fetch my GitHub public profile","step":"execute and save the response as \"profileResponse\"","duration":2},{"feature":"APITests.feature","scenario":"Delete the repo","step":"execute and save the response as \"deleteResponse\"","duration":1},{"feature":"APITests.feature","scenario":"Verify GitHub repo exists","step":"execute and save the response as \"repoCheckResponse\"","duration":1},{"feature":"APITests.feature","scenario":"Create a public repo","step":"compose a post request to \"https://api.github.com/user/repos\" with headers","duration":1},{"feature":"APITests.feature","scenario":"Create a public repo","step":"execute and save the response as \"createRepoResponse\"","duration":1},{"feature":"APITests.feature","scenario":"Fetch my GitHub user details using JWT Token","step":"execute and save the response as \"userProfile\"","duration":1},{"feature":"APITests.feature","scenario":"Verify GitHub repo exists","step":"check that API response \"repoCheckResponse\" contains \"demo-repo\" at \"$.name\"","duration":1}];
        const tableBody = document.getElementById('slowestStepsTable');
        slowestSteps.forEach(step => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${step.feature}</td>
                <td>${step.scenario}</td>
                <td>${step.step}</td>
                <td>${step.duration}</td>
            `;
            tableBody.appendChild(row);
        });

        // Platform Comparison Chart
        const platformLabels = ["null"];
        const platformData = [2.3636363636363638];
        new Chart(document.getElementById('platformComparisonChart'), {
            type: 'bar',
            data: {
                labels: platformLabels,
                datasets: [{
                    label: 'Avg Step Duration (ms)',
                    data: platformData,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        const scenarioTimeline = [{"feature":"file:///Users/amitgupta/Viom/Products/viom-studio/test_suite_repositories/sample-test-suites-repo-1757588379161/test-suite-1758097862241/execution_20250917_124800/src/test/java/com/nimble/feature/APITests.feature","scenario":"Fetch my GitHub public profile","start":"2025-09-17T08:48:05.228638Z","end":"2025-09-17T08:48:05.244764Z"},{"feature":"file:///Users/amitgupta/Viom/Products/viom-studio/test_suite_repositories/sample-test-suites-repo-1757588379161/test-suite-1758097862241/execution_20250917_124800/src/test/java/com/nimble/feature/APITests.feature","scenario":"Fetch my GitHub user details using JWT Token","start":"2025-09-17T08:48:05.256310Z","end":"2025-09-17T08:48:05.262969Z"},{"feature":"file:///Users/amitgupta/Viom/Products/viom-studio/test_suite_repositories/sample-test-suites-repo-1757588379161/test-suite-1758097862241/execution_20250917_124800/src/test/java/com/nimble/feature/APITests.feature","scenario":"Create a public repo","start":"2025-09-17T08:48:05.269213Z","end":"2025-09-17T08:48:05.311608Z"},{"feature":"file:///Users/amitgupta/Viom/Products/viom-studio/test_suite_repositories/sample-test-suites-repo-1757588379161/test-suite-1758097862241/execution_20250917_124800/src/test/java/com/nimble/feature/APITests.feature","scenario":"Verify GitHub repo exists","start":"2025-09-17T08:48:05.317021Z","end":"2025-09-17T08:48:05.331667Z"},{"feature":"file:///Users/amitgupta/Viom/Products/viom-studio/test_suite_repositories/sample-test-suites-repo-1757588379161/test-suite-1758097862241/execution_20250917_124800/src/test/java/com/nimble/feature/APITests.feature","scenario":"Delete the repo","start":"2025-09-17T08:48:05.336392Z","end":"2025-09-17T08:48:05.341976Z"}];

        // Convert ISO strings to Date objects and calculate durations
        const labels = scenarioTimeline.map(s => s.scenario);
        const starts = scenarioTimeline.map(s => new Date(s.start).getTime());
        const ends = scenarioTimeline.map(s => new Date(s.end).getTime());
        const durations = ends.map((end, i) => end - starts[i]);

        const data = {
            labels: labels,
            datasets: [{
                label: 'Execution Time (ms)',
                data: labels.map((_, i) => [starts[i], ends[i]]),
                backgroundColor: 'rgba(75, 192, 192, 0.5)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        };

        new Chart(document.getElementById('timelineChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Scenario Execution',
                    data: durations,
                    backgroundColor: 'rgba(75, 192, 192, 0.5)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1,
                    // For horizontal bar
                    indexAxis: 'y'
                }]
            },
            options: {
                indexAxis: 'y',
                scales: {
                    x: {
                        title: { display: true, text: 'Duration (ms)' }
                    }
                }
            }
        });

        const flaggedSteps = [];
        const stepTrends = [];

        // Populate Flagged Steps Table
        const flaggedTable = document.getElementById('flaggedStepsTable');
        flaggedSteps.forEach(step => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${step.step}</td>
                <td>${step.count}</td>
                <td>${step.avg_duration.toFixed(2)}</td>
            `;
            flaggedTable.appendChild(row);
        });

        // Prepare data for Step Trends Chart
        const builds = [...new Set(stepTrends.map(t => t.build))];
        const steps = [...new Set(stepTrends.map(t => t.step))];
        const datasets = steps.map(step => {
            return {
                label: step,
                data: builds.map(build => {
                    const found = stepTrends.find(t => t.build === build && t.step === step);
                    return found ? found.avg_duration : null;
                }),
                fill: false,
                borderColor: '#' + Math.floor(Math.random()*16777215).toString(16),
                tension: 0.1
            };
        });

        new Chart(document.getElementById('stepTrendsChart'), {
            type: 'line',
            data: {
                labels: builds,
                datasets: datasets
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Step Duration Trends for Slow Steps (Current Run)'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Avg Duration (ms)' }
                    }
                }
            }
        });
    </script>
</body>
</html>